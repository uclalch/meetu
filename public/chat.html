<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MeetU Chat</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        background-color: #f5f7fb;
      }

      .sidebar {
        width: 250px;
        background: white;
        border-right: 1px solid #e2e8f0;
        display: flex;
        flex-direction: column;
      }

      .user-info {
        padding: 1rem;
        border-bottom: 1px solid #e2e8f0;
        background: #667eea;
        color: white;
      }

      .channels {
        flex-grow: 1;
        overflow-y: auto;
        padding: 1rem;
      }

      .channel-item {
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        border-radius: 4px;
        cursor: pointer;
      }

      .channel-item:hover {
        background: #f1f5f9;
      }

      .channel-item.active {
        background: #e2e8f0;
      }

      .main-content {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      .chat-header {
        padding: 1rem;
        background: white;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
      }

      .message {
        max-width: 70%;
        margin-bottom: 1rem;
        padding: 0.75rem;
        border-radius: 8px;
        background: white;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }

      .message.sent {
        align-self: flex-end;
        background: #667eea;
        color: white;
      }

      .message.received {
        align-self: flex-start;
        background: white;
      }

      .message-input {
        padding: 1rem;
        background: white;
        border-top: 1px solid #e2e8f0;
        display: flex;
        gap: 1rem;
      }

      input {
        flex-grow: 1;
        padding: 0.75rem;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        outline: none;
      }

      input:focus {
        border-color: #667eea;
      }

      button {
        padding: 0.75rem 1.5rem;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      button:hover {
        background: #764ba2;
      }

      .status {
        padding: 0.5rem;
        border-radius: 4px;
        margin-bottom: 1rem;
        font-size: 0.875rem;
      }

      .connected {
        color: #16a34a;
      }

      .disconnected {
        color: #dc2626;
      }

      .logout-button {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        background: transparent;
        color: #667eea;
        border: 1px solid #667eea;
      }

      .logout-button:hover {
        background: #f1f5f9;
      }

      .language-selector {
        margin-top: 1rem;
        padding: 0.5rem 0;
      }

      .language-selector label {
        display: block;
        margin-bottom: 0.5rem;
        color: rgba(255, 255, 255, 0.9);
        font-size: 0.9rem;
      }

      .language-selector select {
        width: 100%;
        padding: 0.5rem;
        border-radius: 4px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.1);
        color: white;
      }

      .message {
        max-width: 70%;
        margin-bottom: 1rem;
        padding: 0.75rem;
        border-radius: 8px;
        background: white;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }

      .message .original {
        margin-bottom: 0.3rem;
      }

      .message .translated {
        padding-top: 0.3rem;
        border-top: 1px solid #eee;
        color: #666;
        font-style: italic;
      }

      .message.sent {
        align-self: flex-end;
        background: #667eea;
        color: white;
      }

      .message.sent .translated {
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        color: rgba(255, 255, 255, 0.8);
      }

      .translate-btn {
        background: transparent;
        border: 1px solid #667eea;
        color: #667eea;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        cursor: pointer;
        margin-top: 8px;
        transition: all 0.3s ease;
      }

      .translate-btn:hover {
        background: #667eea;
        color: white;
      }

      .translate-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .message.received .translate-btn {
        border-color: #667eea;
        color: #667eea;
      }

      .message.received .translate-btn:hover {
        background: #667eea;
        color: white;
      }

      .translated-text {
        color: #666;
        font-style: italic;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid #eee;
      }

      .message.sent .translated-text {
        color: rgba(255, 255, 255, 0.8);
        border-top: 1px solid rgba(255, 255, 255, 0.2);
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <div class="user-info">
        <h3 id="username">Loading...</h3>
        <div id="connectionStatus" class="status disconnected">
          Disconnected
        </div>
        <div class="language-selector">
          <label for="preferredLanguage">Preferred Language:</label>
          <select id="preferredLanguage" onchange="updatePreferredLanguage()">
            <option value="en">English</option>
            <option value="zh">Chinese</option>
            <option value="es">Spanish</option>
            <option value="fr">French</option>
            <option value="ja">Japanese</option>
            <option value="ko">Korean</option>
          </select>
        </div>
      </div>
      <div class="channels">
        <h4>Channels</h4>
        <div class="channel-item active">General</div>
        <div class="channel-item">Random</div>
        <div class="channel-item">Support</div>
      </div>
    </div>

    <div class="main-content">
      <div class="chat-header">
        <h2 id="currentChannel">General</h2>
        <button class="logout-button" onclick="handleLogout()">Logout</button>
      </div>

      <div id="messages" class="messages"></div>

      <div class="message-input">
        <input type="text" id="messageInput" placeholder="Type a message..." />
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>

    <script>
      let socket = null;
      let currentChannel = "general";
      let userData = null;
      let preferredLanguage = "en";

      function updatePreferredLanguage() {
        const newLanguage = document.getElementById("preferredLanguage").value;
        console.log("Updating preferred language to:", newLanguage);
        preferredLanguage = newLanguage;
        localStorage.setItem("preferredLanguage", preferredLanguage);

        // Update user data
        userData.languagePreference = preferredLanguage;
        localStorage.setItem("user", JSON.stringify(userData));
      }

      function initializeSocket() {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "/login.html";
          return;
        }

        userData = JSON.parse(localStorage.getItem("user"));
        if (!userData) {
          window.location.href = "/login.html";
          return;
        }

        document.getElementById("username").textContent = userData.username;

        // Set initial preferred language
        preferredLanguage = localStorage.getItem("preferredLanguage") || "en";
        document.getElementById("preferredLanguage").value = preferredLanguage;
        console.log("Initial preferred language:", preferredLanguage);

        socket = io({
          auth: { token },
          transports: ["websocket", "polling"],
        });

        socket.on("connect", () => {
          document.getElementById("connectionStatus").className =
            "status connected";
          document.getElementById("connectionStatus").textContent = "Connected";
          joinChannel(currentChannel);
        });

        socket.on("connect_error", (error) => {
          document.getElementById("connectionStatus").className =
            "status disconnected";
          document.getElementById("connectionStatus").textContent =
            "Connection Error";
        });

        socket.on("chat-message", (message) => {
          appendMessage(message);
        });
      }

      function joinChannel(channelName) {
        if (!socket?.connected) return;

        socket.emit("join", {
          username: userData.username,
          userId: userData.id,
          channel: channelName,
        });

        currentChannel = channelName;
        document.getElementById("currentChannel").textContent = channelName;
      }

      function sendMessage() {
        if (!socket?.connected) return;

        const input = document.getElementById("messageInput");
        const content = input.value.trim();
        if (!content) return;

        const messageData = {
          content,
          channel: currentChannel,
          sender: userData,
          language: "auto", // Let Tencent API detect the language
        };

        console.log("Sending message:", messageData);
        socket.emit("chat-message", messageData);

        input.value = "";
      }

      function appendMessage(message) {
        console.log("Message details:", {
          content: message.content,
          messageLanguage: message.language,
          receiverPreferredLanguage: preferredLanguage,
          isSender: message.sender.id === userData.id,
        });

        const messagesDiv = document.getElementById("messages");
        const messageElement = document.createElement("div");
        messageElement.className = `message ${
          message.sender.id === userData.id ? "sent" : "received"
        }`;

        // Original message
        const originalDiv = document.createElement("div");
        originalDiv.className = "original";
        originalDiv.textContent = `${message.sender.username}: ${message.content}`;
        messageElement.appendChild(originalDiv);

        // Handle translation for received messages
        if (message.sender.id !== userData.id) {
          // Only show translate button if message language is different from preferred language
          // and if the language was successfully detected (not 'auto')
          if (
            message.language !== preferredLanguage &&
            message.language !== "auto"
          ) {
            const translatedDiv = document.createElement("div");
            translatedDiv.className = "translated";

            const translateButton = document.createElement("button");
            translateButton.className = "translate-btn";
            translateButton.textContent = `Translate to ${getLanguageName(
              preferredLanguage
            )}`;

            translateButton.onclick = () => {
              translateButton.disabled = true;
              translateButton.textContent = "Translating...";

              socket.emit(
                "translate-message",
                {
                  text: message.content,
                  from: message.language,
                  to: preferredLanguage,
                },
                (response) => {
                  if (response.error) {
                    translateButton.textContent = "Translation unavailable";
                    translateButton.style.opacity = "0.5";
                  } else {
                    const translatedText = document.createElement("div");
                    translatedText.className = "translated-text";
                    translatedText.textContent = response.text;
                    translatedDiv.innerHTML = "";
                    translatedDiv.appendChild(translatedText);
                  }
                }
              );
            };

            translatedDiv.appendChild(translateButton);
            messageElement.appendChild(translatedDiv);
          }
        }

        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function handleLogout() {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        window.location.href = "/login.html";
      }

      // Handle Enter key for sending messages
      document
        .getElementById("messageInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            sendMessage();
          }
        });

      // Channel switching
      document.querySelectorAll(".channel-item").forEach((item) => {
        item.addEventListener("click", function () {
          document
            .querySelector(".channel-item.active")
            .classList.remove("active");
          this.classList.add("active");
          joinChannel(this.textContent);
        });
      });

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", () => {
        initializeSocket();

        // Load saved language preference
        const savedLanguage = localStorage.getItem("preferredLanguage");
        if (savedLanguage) {
          preferredLanguage = savedLanguage;
          document.getElementById("preferredLanguage").value = savedLanguage;
        }
      });

      // Helper function to get language names
      function getLanguageName(code) {
        const languages = {
          en: "English",
          zh: "Chinese",
          es: "Spanish",
          fr: "French",
          ja: "Japanese",
          ko: "Korean",
        };
        return languages[code] || code;
      }
    </script>
  </body>
</html>
